# Dexie-Based Offline Storage System

This directory contains the unified offline-first storage system using Dexie.js (IndexedDB wrapper).

## Overview

All entities are stored locally in IndexedDB using Dexie, with automatic synchronization to the server when online.

## Key Concepts

### Status System
- `'w'` - Waiting for sync (new/updated records)
- `'1'` - Synced (successfully synced to server)
- `'0'` - Marked for deletion (pending deletion on server)

### Data Flow

1. **Save Locally First**: All data is saved to `localDb` with status `'w'`
2. **Sync When Online**: When internet is available, sync worker syncs all pending items
3. **Mark as Synced**: After successful sync, status changes to `'1'`

## Files

### `dbSchema.ts`
Defines the database schema and all entity interfaces:
- `User` - Admins and managers
- `Center` - Education centers
- `Teacher` - Teachers
- `Student` - Students
- `Subject` - Subjects/courses
- `Receipt` - Payment receipts
- `Schedule` - Class schedules
- `TeacherSubject` - Teacher-subject assignments
- `StudentSubject` - Student enrollments
- `PushSubscription` - Push notification subscriptions

### `dexieActions.ts`
Provides generic CRUD operations for all entities:
- `putLocal(item)` - Save/update entity
- `getAll()` - Get all entities
- `getLocal(id)` - Get entity by ID
- `getLocalByEmail(email)` - Get user by email
- `deleteLocal(id)` - Delete entity
- `markForDelete(id)` - Mark entity for deletion (status '0')
- `markSynced(id)` - Mark entity as synced (status '1')
- `getSyncTargets()` - Get entities waiting for sync or deletion

### `syncWorker.ts`
Handles synchronization of all entities to the server:
- `syncPendingEntities()` - Sync all pending entities
- `syncPendingUsers()` - Sync users (admins/managers)
- `syncPendingCenters()` - Sync centers
- `syncPendingTeachers()` - Sync teachers
- `syncPendingStudents()` - Sync students
- `syncPendingSubjects()` - Sync subjects
- `syncPendingReceipts()` - Sync receipts
- `syncPendingSchedules()` - Sync schedules

## Usage

### Saving Entities

```typescript
import { saveStudentToLocalDb } from '@/lib/utils/saveToLocalDb';
import { syncPendingEntities } from '@/lib/dexie/syncWorker';

// Save student locally (status 'w')
const student = await saveStudentToLocalDb({
  name: 'John Doe',
  email: 'john@example.com',
  managerId: 'manager-id',
});

// Trigger sync if online
if (navigator.onLine) {
  await syncPendingEntities();
}
```

### Reading Entities

```typescript
import { studentActions } from '@/lib/dexie/dexieActions';

// Get all students
const students = await studentActions.getAll();

// Get student by ID
const student = await studentActions.getLocal('student-id');

// Get students by manager
const managerStudents = students.filter(s => s.managerId === 'manager-id');
```

### Updating Entities

```typescript
import { studentActions } from '@/lib/dexie/dexieActions';

// Update student (status becomes 'w' automatically)
await studentActions.putLocal({
  ...existingStudent,
  name: 'Updated Name',
  updatedAt: Date.now(),
});

// Sync changes
await syncPendingEntities();
```

### Deleting Entities

```typescript
import { studentActions } from '@/lib/dexie/dexieActions';

// Mark for deletion (status '0')
await studentActions.markForDelete('student-id');

// Sync deletion
await syncPendingEntities();

// Or delete immediately (removes from localDb)
await studentActions.deleteLocal('student-id');
```

## Utility Functions

### `saveToLocalDb.ts`
Contains utility functions to save all entity types:
- `saveCenterToLocalDb(centerData)`
- `saveTeacherToLocalDb(teacherData)`
- `saveStudentToLocalDb(studentData)`
- `saveSubjectToLocalDb(subjectData)`
- `saveReceiptToLocalDb(receiptData)`
- `saveScheduleToLocalDb(scheduleData)`

### `saveManagerToLocalDb.ts`
Special utility for saving users (admins/managers) with password hashing:
- `saveManagerToLocalDb(userData, plainPassword)`
- `getPlainPasswordForSync(email)` - Get plain password for sync
- `clearPlainPasswordForSync(email)` - Clear password after sync

## Auto-Sync

The sync worker automatically syncs when:
- Connection is restored (online event)
- Manually triggered via `syncPendingEntities()`

## ID Generation

All entities use MongoDB-compatible ObjectId format (24-character hex string) generated by `generateObjectId()`. This ensures consistency between client and server IDs.

## Migration from Old System

The old `offlineStore` (localStorage-based) system is deprecated. To migrate:

1. Replace `offlineStore` imports with `dexieActions`
2. Replace `offlineApi` functions with `saveToLocalDb` utilities
3. Replace `syncEngine` with `syncWorker`
4. Update status from `'pending'/'synced'/'failed'` to `'w'/'1'/'0'`

## Best Practices

1. **Always save locally first** - Save to `localDb` with status `'w'` before syncing
2. **Trigger sync after save** - If online, trigger sync immediately after saving
3. **Handle sync errors** - Sync failures keep status as `'w'` for retry
4. **Use consistent IDs** - Generate IDs on client using `generateObjectId()`
5. **Store passwords temporarily** - For users, store plain passwords in sessionStorage for sync

